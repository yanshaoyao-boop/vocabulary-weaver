<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contextual Vocabulary Weaver | ËØ≠Â¢ÉËØçÊ±áÁºñÁªáËÄÖ</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        /* Global Reset & Typography */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --bg-color: #f8f9fa;
            --text-main: #2d3748;
            --text-light: #718096;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --accent-color: #667eea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            padding: 2.5rem;
            margin-top: 2rem;
            animation: fadeIn 0.8s ease-out;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        h1 {
            font-size: 2.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        /* Input Section */
        .input-section {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        textarea,
        select,
        input {
            width: 100%;
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        textarea:focus,
        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }

        /* Options Row (Checkbox area) */
        .options-row {
            display: flex;
            gap: 2rem;
            padding: 0.5rem 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-main);
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .checkbox-label input[type="checkbox"]:checked+.checkbox-custom {
            background: var(--accent-color);
        }

        .checkbox-label input[type="checkbox"]:checked+.checkbox-custom::after {
            content: "‚úì";
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Translation Box - Collapsible */
        .translation-box {
            margin-top: 1rem;
            background: linear-gradient(135deg, #fef9e7 0%, #fdebd0 100%);
            border-radius: 12px;
            border-left: 4px solid #f39c12;
            overflow: hidden;
        }

        .translation-box.collapsible .translation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 1rem 1.25rem;
            transition: background 0.2s;
        }

        .translation-box.collapsible .translation-header:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .translation-header {
            font-weight: 600;
            color: #b7791f;
            font-size: 0.95rem;
        }

        .translation-header ion-icon {
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .translation-text {
            color: #5d4e37;
            line-height: 1.7;
            font-size: 1rem;
            padding: 0 1.25rem 1.25rem;
            max-height: 500px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .translation-text.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .speed-select,
        .voice-select {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .speed-select {
            min-width: 100px;
        }

        .voice-select {
            max-width: 150px;
        }

        .playback-btns {
            display: flex;
            gap: 0.5rem;
        }

        .playback-btns .speak-btn {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .playback-btns .speak-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .playback-btns .speak-btn ion-icon {
            font-size: 1.1rem;
        }

        .settings-toggle {
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .api-settings {
            display: none;
            background: rgba(0, 0, 0, 0.03);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .api-settings.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Button */
        .btn-generate {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: var(--primary-gradient);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4);
        }

        .btn-generate:active {
            transform: translateY(0);
        }

        .btn-generate:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #ccc;
        }

        /* Results Section */
        .results-section {
            display: none;
            /* Hidden by default */
            margin-top: 3rem;
            animation: fadeIn 0.5s ease-out;
        }

        .results-section.active {
            display: block;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: rgba(102, 126, 234, 0.1);
            color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .story-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 16px;
            line-height: 1.8;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .story-text {
            white-space: pre-wrap;
        }

        .highlight-word {
            color: #667eea;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            border-bottom: 2px dotted #667eea;
        }

        .highlight-word:hover {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        /* Vocab List */
        .vocab-list {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .vocab-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .vocab-card:hover {
            transform: translateY(-3px);
        }

        .vocab-word {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .speak-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--accent-color);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .speak-btn:hover {
            opacity: 1;
        }

        .vocab-def {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .vocab-example {
            font-style: italic;
            color: #4a5568;
            font-size: 0.9rem;
            background: #f7fafc;
            padding: 0.5rem;
            border-radius: 6px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                display: none;
            }

            to {
                opacity: 1;
                transform: translateY(0);
                display: block;
            }
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ============== Quiz Section Styles ============== */
        .quiz-section {
            margin-top: 2rem;
            background: linear-gradient(135deg, #e8f4fd 0%, #f0e6ff 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
            animation: fadeIn 0.4s ease;
        }

        .quiz-header {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .quiz-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .quiz-question {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .question-number {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.25rem;
            line-height: 1.5;
        }

        .question-text-cn {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .quiz-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafbfc;
        }

        .quiz-option:hover {
            border-color: var(--accent-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .quiz-option input[type="radio"] {
            display: none;
        }

        .option-marker {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            color: var(--text-main);
        }

        /* Selected state */
        .quiz-option:has(input:checked) {
            border-color: var(--accent-color);
            background: rgba(102, 126, 234, 0.1);
        }

        /* Correct/Incorrect states after submission */
        .quiz-option.correct {
            border-color: #38a169;
            background: rgba(56, 161, 105, 0.15);
        }

        .quiz-option.correct .option-marker {
            background: #38a169;
        }

        .quiz-option.incorrect {
            border-color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }

        .quiz-option.incorrect .option-marker {
            background: #e53e3e;
        }

        /* Submit Button */
        .btn-submit-quiz {
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.9rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }

        .btn-submit-quiz:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(56, 161, 105, 0.4);
        }

        .btn-submit-quiz:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Quiz Result */
        .quiz-result {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 12px;
            background: white;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .result-score {
            font-size: 1.1rem;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .result-grade {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .grade-excellent {
            color: #d69e2e;
            background: linear-gradient(135deg, #faf089 0%, #f6e05e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .grade-good {
            color: #38a169;
        }

        .grade-fail {
            color: #e53e3e;
        }
    </style>
    <!-- Ionicons for icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icon.svg">
<link rel="apple-touch-icon" href="icon.svg">
<meta name="theme-color" content="#667eea">

<body>
    <div class="container">
        <header>
            <h1>Vocabulary Weaver</h1>
            <p class="subtitle">Personalized Contextual Learning Assistant | ‰∏™ÊÄßÂåñËØ≠Â¢ÉÂ≠¶‰π†Âä©Êâã</p>
        </header>

        <section class="input-section">
            <div class="input-group">
                <label for="wordsInput">ËæìÂÖ•ÈúÄË¶ÅËÆ∞ÂøÜÁöÑÂçïËØç (Áî®ÈÄóÂè∑ÂàÜÈöî):</label>
                <textarea id="wordsInput" placeholder="‰æãÂ¶Ç: serendipity, ephemeral, labyrinth..."></textarea>
            </div>

            <div class="controls">
                <div class="input-group">
                    <label for="themeSelect">ÈÄâÊã©ÊïÖ‰∫ã‰∏ªÈ¢ò:</label>
                    <select id="themeSelect">
                        <option value="magic">üßô‚Äç‚ôÇÔ∏è ÂìàÂà©Ê≥¢Áâπ‰∏éÈ≠îÊ≥ï‰∏ñÁïå (Harry Potter / Magic)</option>
                        <option value="detective">üïµÔ∏è‚Äç‚ôÄÔ∏è ÊÇ¨Áñë‰æ¶Êé¢ÊïÖ‰∫ã (Detective / Mystery)</option>
                        <option value="scifi">üöÄ ÁßëÂπª‰∏éÊú™Êù• (Sci-Fi / Future)</option>
                        <option value="daily">üè´ Ê†°Âõ≠Êó•Â∏∏ÁîüÊ¥ª (Daily Life / School)</option>
                        <option value="adventure">üó∫Ô∏è ‰∏õÊûóÊé¢Èô© (Jungle Adventure)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="difficultySelect">ÈÄâÊã©ÈöæÂ∫¶Á≠âÁ∫ß (CEFR):</label>
                    <select id="difficultySelect">
                        <option value="A1">üå± A1 - ÂÖ•Èó®Á∫ß (Beginner)</option>
                        <option value="A2">üåø A2 - Âü∫Á°ÄÁ∫ß (Elementary)</option>
                        <option value="B1" selected>üå≥ B1 - ‰∏≠Á∫ß (Intermediate)</option>
                        <option value="B2">üå≤ B2 - ‰∏≠È´òÁ∫ß (Upper-Intermediate)</option>
                        <option value="C1">üèîÔ∏è C1 - È´òÁ∫ß (Advanced)</option>
                    </select>
                </div>
            </div>



            <div class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è API ËÆæÁΩÆ (Advanced)</div>
            <div class="api-settings" id="apiSettings">
                <div class="input-group">
                    <label for="apiKey">API Key (OpenAI Compatible):</label>
                    <input type="password" id="apiKey" value="d0fc4fd9-9181-4a18-808e-7a4000b187fb">
                </div>
                <div class="input-group" style="margin-top: 10px;">
                    <label for="modelId">Model ID:</label>
                    <input type="text" id="modelId" value="doubao-seed-1-6-flash-250828">
                </div>
            </div>

            <button id="generateBtn" class="btn-generate" onclick="generateStory()">
                ‚ú® ÁîüÊàêËØ≠Â¢ÉÊïÖ‰∫ã (Weave Context)
            </button>
        </section>

        <section class="results-section" id="resultsSection">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('simple')">üìñ Ë∂£Âë≥ÊïÖ‰∫ã (Simple Story)</button>
                <button class="tab-btn" onclick="switchTab('complex')">üì∞ ÁúüÂÆûËØ≠Â¢É (Complex Usage)</button>
                <button class="tab-btn" onclick="switchTab('analysis')">üß© ËØçÊ±áËß£Êûê (Analysis)</button>
            </div>

            <!-- Simple Story Content -->
            <div id="simpleTab" class="tab-content active">
                <div class="story-card">
                    <div id="simpleTextOutput" class="story-text">
                        <!-- Content will be injected here -->
                    </div>
                </div>
                <!-- Collapsible Translation -->
                <div id="simpleTranslationBox" class="translation-box collapsible">
                    <div class="translation-header" onclick="toggleTranslation('simple')">
                        <span>üìù ‰∏≠ÊñáÁøªËØë</span>
                        <ion-icon id="simpleTransIcon" name="chevron-down-outline"></ion-icon>
                    </div>
                    <div id="simpleTranslation" class="translation-text collapsed"></div>
                </div>
                <!-- Audio Controls -->
                <div class="audio-controls">
                    <div class="control-group">
                        <label>ËØ≠Èü≥:</label>
                        <select id="simpleVoiceSelect" class="voice-select">
                            <option value="">ÈªòËÆ§ËØ≠Èü≥</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="simpleSpeedSelect" class="speed-select">
                            <option value="0.5">0.5x ÊÖ¢ÈÄü</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x Ê≠£Â∏∏</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x Âø´ÈÄü</option>
                        </select>
                    </div>
                    <div class="playback-btns">
                        <button class="speak-btn" id="simplePlayBtn" onclick="togglePlayback('simple')">
                            <ion-icon name="play-outline" size="large"></ion-icon> ÊúóËØª
                        </button>
                        <button class="speak-btn" onclick="stopPlayback()">
                            <ion-icon name="stop-outline" size="large"></ion-icon> ÂÅúÊ≠¢
                        </button>
                    </div>
                </div>
                <!-- Quiz Section for Simple Story -->
                <div id="simpleQuizSection" class="quiz-section" style="display: none;">
                    <div class="quiz-header">üìö ÈòÖËØªÁêÜËß£ÊµãËØï</div>
                    <div id="simpleQuizList" class="quiz-list"></div>
                    <button id="simpleSubmitQuiz" class="btn-submit-quiz" onclick="submitQuiz('simple')">Êèê‰∫§Á≠îÊ°à</button>
                    <div id="simpleQuizResult" class="quiz-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Complex Text Content -->
            <div id="complexTab" class="tab-content">
                <div class="story-card" style="border-left: 5px solid #2c5282;">
                    <div id="complexTextOutput" class="story-text">
                        <!-- Content will be injected here -->
                    </div>
                </div>
                <!-- Collapsible Translation -->
                <div id="complexTranslationBox" class="translation-box collapsible">
                    <div class="translation-header" onclick="toggleTranslation('complex')">
                        <span>üìù ‰∏≠ÊñáÁøªËØë</span>
                        <ion-icon id="complexTransIcon" name="chevron-down-outline"></ion-icon>
                    </div>
                    <div id="complexTranslation" class="translation-text collapsed"></div>
                </div>
                <!-- Audio Controls -->
                <div class="audio-controls">
                    <div class="control-group">
                        <label>ËØ≠Èü≥:</label>
                        <select id="complexVoiceSelect" class="voice-select">
                            <option value="">ÈªòËÆ§ËØ≠Èü≥</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>ÈÄüÂ∫¶:</label>
                        <select id="complexSpeedSelect" class="speed-select">
                            <option value="0.5">0.5x ÊÖ¢ÈÄü</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x Ê≠£Â∏∏</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x Âø´ÈÄü</option>
                        </select>
                    </div>
                    <div class="playback-btns">
                        <button class="speak-btn" id="complexPlayBtn" onclick="togglePlayback('complex')">
                            <ion-icon name="play-outline" size="large"></ion-icon> ÊúóËØª
                        </button>
                        <button class="speak-btn" onclick="stopPlayback()">
                            <ion-icon name="stop-outline" size="large"></ion-icon> ÂÅúÊ≠¢
                        </button>
                    </div>
                </div>
                <!-- Quiz Section for Complex Text -->
                <div id="complexQuizSection" class="quiz-section" style="display: none;">
                    <div class="quiz-header">üìö ÈòÖËØªÁêÜËß£ÊµãËØï</div>
                    <div id="complexQuizList" class="quiz-list"></div>
                    <button id="complexSubmitQuiz" class="btn-submit-quiz" onclick="submitQuiz('complex')">Êèê‰∫§Á≠îÊ°à</button>
                    <div id="complexQuizResult" class="quiz-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Vocabulary Analysis Content -->
            <div id="analysisTab" class="tab-content">
                <div id="vocabList" class="vocab-list">
                    <!-- Vocab cards generated here -->
                </div>
            </div>
        </section>
    </div>

    <script>

        // State
        let generatedData = null;

        // UI Toggles
        function toggleSettings() {
            const settings = document.getElementById('apiSettings');
            settings.classList.toggle('show');
        }

        function switchTab(tabName) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            // Show specific
            if (tabName === 'simple') {
                document.getElementById('simpleTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            } else if (tabName === 'complex') {
                document.getElementById('complexTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
            } else if (tabName === 'analysis') {
                document.getElementById('analysisTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
            }
        }

        // CEFR ÈöæÂ∫¶Á≠âÁ∫ßÊèèËø∞Êò†Â∞Ñ
        const CEFR_DESCRIPTIONS = {
            'A1': {
                name: 'Beginner (ÂÖ•Èó®Á∫ß)',
                guidelines: `
- Use only the most basic vocabulary (high-frequency words like: is, have, go, come, like, want)
- Very short, simple sentences (5-8 words max)
- Present tense only
- No idioms, no phrasal verbs
- Repetition of key structures is encouraged
- Story length: approx 80 words
- Complex text: approx 50 words, still simple but slightly more formal`
            },
            'A2': {
                name: 'Elementary (Âü∫Á°ÄÁ∫ß)',
                guidelines: `
- Common everyday vocabulary
- Simple and compound sentences (use "and", "but", "because")
- Past simple and present continuous allowed
- Basic phrasal verbs (look at, get up)
- Story length: approx 100 words
- Complex text: approx 70 words`
            },
            'B1': {
                name: 'Intermediate (‰∏≠Á∫ß)',
                guidelines: `
- Wider range of vocabulary including some less common words
- Complex sentences with dependent clauses (when, if, although)
- All basic tenses including present perfect
- Common idioms and phrasal verbs allowed
- Story length: approx 150 words
- Complex text: approx 100 words`
            },
            'B2': {
                name: 'Upper-Intermediate (‰∏≠È´òÁ∫ß)',
                guidelines: `
- Rich vocabulary including abstract and topic-specific words
- Complex sentence structures, passive voice, conditionals
- All tenses including past perfect
- Idiomatic expressions and varied phrasal verbs
- Story length: approx 180 words
- Complex text: approx 120 words, more formal and nuanced`
            },
            'C1': {
                name: 'Advanced (È´òÁ∫ß)',
                guidelines: `
- Sophisticated and nuanced vocabulary
- Complex grammatical structures, advanced conditionals, subjunctive
- Idiomatic and colloquial expressions freely used
- Subtle shades of meaning, irony, and rhetorical devices
- Story length: approx 200+ words
- Complex text: approx 150 words, academic or journalistic style`
            }
        };

        // Main Generation Logic
        async function generateStory() {
            const words = document.getElementById('wordsInput').value;
            const theme = document.getElementById('themeSelect').options[document.getElementById('themeSelect').selectedIndex].text;
            const difficulty = document.getElementById('difficultySelect').value;
            const difficultyInfo = CEFR_DESCRIPTIONS[difficulty];
            const apiKey = document.getElementById('apiKey').value;
            const modelId = document.getElementById('modelId').value;
            const btn = document.getElementById('generateBtn');

            if (!words.trim()) {
                alert("Please enter some words!");
                return;
            }

            // UI Loading State
            btn.innerHTML = '<div class="loader"></div> Generating...';
            btn.disabled = true;

            // Prompt Construction with CEFR level
            const systemPrompt = `You are an expert English teacher specializing in CEFR-aligned content creation.
    The learner's current level is: **${difficulty} - ${difficultyInfo.name}**.
    
    IMPORTANT LANGUAGE GUIDELINES for ${difficulty}:
    ${difficultyInfo.guidelines}

    Your task is to take a list of words and a theme, then generate the following in JSON format:
    1. 'simple_text': An engaging short story using ALL the input words naturally. The story MUST follow the theme: "${theme}". Strictly adhere to the ${difficulty} language guidelines above.
    2. 'simple_text_cn': The Chinese translation of 'simple_text'. Should be natural and fluent Chinese.
    3. 'simple_quiz': An array of exactly 3 multiple-choice questions about the simple_text story. Each question object must have:
       - 'question': The question in English (suitable for ${difficulty} level).
       - 'question_cn': Chinese translation of the question.
       - 'options': An array of exactly 4 options (A, B, C, D).
       - 'correct_answer': The correct option letter (A, B, C, or D).
    4. 'complex_text': A slightly more formal text (news snippet, diary entry, or informational paragraph) using the words. Still respects the ${difficulty} level but feels more "real-world".
    5. 'complex_text_cn': The Chinese translation of 'complex_text'.
    6. 'complex_quiz': An array of exactly 3 multiple-choice questions about the complex_text. Same format as simple_quiz.
    7. 'vocabulary_data': An array of objects for each input word. Each object must have:
       - 'word': The word itself.
       - 'definition_cn': A concise Chinese definition.
       - 'pronunciation_guide': IPA or phonetic spelling.
       - 'sentence_example': A separate example sentence (not from the story), suitable for ${difficulty} level.

    IMPORTANT: Return ONLY valid JSON. No extra text before or after.
    `;

            const userPrompt = `Words: ${words}`;

            try {
                const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                // Parse JSON (Handling potential markdown code blocks)
                let jsonStr = content;
                if (content.includes('```json')) {
                    jsonStr = content.split('```json')[1].split('```')[0].trim();
                } else if (content.includes('```')) {
                    jsonStr = content.split('```')[1].split('```')[0].trim();
                }

                generatedData = JSON.parse(jsonStr);
                renderResults(generatedData, words.split(',').map(w => w.trim()));

            } catch (error) {
                console.error(error);
                alert("Error generating content: " + error.message);
            } finally {
                btn.innerHTML = '‚ú® ÁîüÊàêËØ≠Â¢ÉÊïÖ‰∫ã (Weave Context)';
                btn.disabled = false;
            }
        }

        // Rendering Logic
        function renderResults(data, inputWords) {
            document.getElementById('resultsSection').classList.add('active');


            // Highlight function
            const highlight = (text) => {
                let processedText = text;
                // Identify words to highlight (case insensitive)
                inputWords.forEach(word => {
                    if (word.length < 2) return;
                    // No tooltip, just highlight and click-to-speak
                    const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                    processedText = processedText.replace(regex, `<span class="highlight-word" onclick="speakWord('$1')">$1</span>`);
                });
                return processedText;
            };

            // Render Texts
            document.getElementById('simpleTextOutput').innerHTML = highlight(data.simple_text);
            document.getElementById('complexTextOutput').innerHTML = highlight(data.complex_text);

            // Render Translations (always render, but start collapsed)
            const simpleTransBox = document.getElementById('simpleTranslationBox');
            const complexTransBox = document.getElementById('complexTranslationBox');

            if (data.simple_text_cn) {
                document.getElementById('simpleTranslation').textContent = data.simple_text_cn;
                simpleTransBox.style.display = 'block';
            } else {
                simpleTransBox.style.display = 'none';
            }

            if (data.complex_text_cn) {
                document.getElementById('complexTranslation').textContent = data.complex_text_cn;
                complexTransBox.style.display = 'block';
            } else {
                complexTransBox.style.display = 'none';
            }

            // Render Quizzes
            if (data.simple_quiz && data.simple_quiz.length > 0) {
                renderQuiz('simple', data.simple_quiz);
            }
            if (data.complex_quiz && data.complex_quiz.length > 0) {
                renderQuiz('complex', data.complex_quiz);
            }

            // Render Vocab Analysis
            const vocabContainer = document.getElementById('vocabList');
            vocabContainer.innerHTML = '';

            data.vocabulary_data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'vocab-card';
                card.innerHTML = `
            <div class="vocab-word">
                ${item.word}
                <button class="speak-btn" onclick="speakWord('${item.word}')">
                    <ion-icon name="volume-medium"></ion-icon>
                </button>
            </div>
            <div class="vocab-def">/${item.pronunciation_guide}/ ${item.definition_cn}</div>
            <div class="vocab-example">"${item.sentence_example}"</div>
        `;
                vocabContainer.appendChild(card);
            });
        }

        // TTS State
        let currentUtterance = null;
        let isPaused = false;
        let currentType = null;
        let voices = [];

        function populateVoices() {
            voices = window.speechSynthesis.getVoices();
            const voiceSelects = [
                document.getElementById('simpleVoiceSelect'),
                document.getElementById('complexVoiceSelect')
            ];

            voiceSelects.forEach(select => {
                if (!select) return;
                // Keep the default option
                const defaultOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(defaultOption);

                voices.forEach((voice, index) => {
                    // Filter for English voices primarily, or all if preferred
                    if (voice.lang.includes('en')) {
                        const option = document.createElement('option');
                        option.textContent = `${voice.name} (${voice.lang})`;
                        option.value = index;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Wait for voices to be loaded
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = populateVoices;
        }
        // Also try immediately
        populateVoices();

        // Toggle Translation Collapse
        function toggleTranslation(type) {
            const textEl = document.getElementById(`${type}Translation`);
            const iconEl = document.getElementById(`${type}TransIcon`);

            if (textEl.classList.contains('collapsed')) {
                textEl.classList.remove('collapsed');
                iconEl.setAttribute('name', 'chevron-up-outline');
            } else {
                textEl.classList.add('collapsed');
                iconEl.setAttribute('name', 'chevron-down-outline');
            }
        }

        // TTS with Speed and Pause/Resume
        function togglePlayback(type) {
            const synth = window.speechSynthesis;
            const playBtn = document.getElementById(`${type}PlayBtn`);
            const speedSelect = document.getElementById(`${type}SpeedSelect`);
            const speed = parseFloat(speedSelect.value);

            // Voice selection
            const voiceSelect = document.getElementById(`${type}VoiceSelect`);
            const selectedVoiceIndex = voiceSelect.value;


            // If already speaking this type, toggle pause/resume
            if (synth.speaking && currentType === type) {
                if (isPaused) {
                    synth.resume();
                    isPaused = false;
                    playBtn.innerHTML = '<ion-icon name="pause-outline" size="large"></ion-icon> ÊöÇÂÅú';
                } else {
                    synth.pause();
                    isPaused = true;
                    playBtn.innerHTML = '<ion-icon name="play-outline" size="large"></ion-icon> ÁªßÁª≠';
                }
                return;
            }

            // Start new playback
            synth.cancel();
            isPaused = false;
            currentType = type;

            const textEl = document.getElementById(`${type}TextOutput`);
            const text = textEl.innerText;

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = speed;

            // Apply selected voice if any
            if (selectedVoiceIndex !== "") {
                currentUtterance.voice = voices[selectedVoiceIndex];
            }

            currentUtterance.onstart = () => {
                playBtn.innerHTML = '<ion-icon name="pause-outline" size="large"></ion-icon> ÊöÇÂÅú';
            };

            currentUtterance.onend = () => {
                playBtn.innerHTML = '<ion-icon name="play-outline" size="large"></ion-icon> ÊúóËØª';
                currentType = null;
            };

            currentUtterance.onerror = () => {
                playBtn.innerHTML = '<ion-icon name="play-outline" size="large"></ion-icon> ÊúóËØª';
                currentType = null;
            };

            synth.speak(currentUtterance);
        }

        function stopPlayback() {
            const synth = window.speechSynthesis;
            synth.cancel();
            isPaused = false;
            currentType = null;

            // Reset all play buttons
            ['simple', 'complex'].forEach(type => {
                const btn = document.getElementById(`${type}PlayBtn`);
                if (btn) {
                    btn.innerHTML = '<ion-icon name="play-outline" size="large"></ion-icon> ÊúóËØª';
                }
            });
        }

        function speakWord(word) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        }

        // Quiz State
        let quizAnswers = {
            simple: {},
            complex: {}
        };

        // Render Quiz
        function renderQuiz(type, quizData) {
            const quizSection = document.getElementById(`${type}QuizSection`);
            const quizList = document.getElementById(`${type}QuizList`);
            const resultBox = document.getElementById(`${type}QuizResult`);
            const submitBtn = document.getElementById(`${type}SubmitQuiz`);

            // Reset state
            quizAnswers[type] = {};
            resultBox.style.display = 'none';
            submitBtn.style.display = 'block';
            submitBtn.disabled = false;
            quizList.innerHTML = '';
            quizSection.style.display = 'block';

            quizData.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.dataset.correctAnswer = q.correct_answer;

                let optionsHtml = '';
                const optionLabels = ['A', 'B', 'C', 'D'];
                q.options.forEach((opt, optIndex) => {
                    const label = optionLabels[optIndex];
                    optionsHtml += `
                <label class="quiz-option" data-option="${label}">
                    <input type="radio" name="${type}_q${index}" value="${label}" onchange="selectAnswer('${type}', ${index}, '${label}')">
                    <span class="option-marker">${label}</span>
                    <span class="option-text">${opt}</span>
                </label>
            `;
                });

                questionDiv.innerHTML = `
            <div class="question-number">Á¨¨ ${index + 1} È¢ò</div>
            <div class="question-text">${q.question}</div>
            <div class="question-text-cn">${q.question_cn || ''}</div>
            <div class="options-list">${optionsHtml}</div>
        `;
                quizList.appendChild(questionDiv);
            });
        }

        // Select Answer
        function selectAnswer(type, questionIndex, answer) {
            quizAnswers[type][questionIndex] = answer;
        }

        // Submit Quiz
        function submitQuiz(type) {
            const quizData = type === 'simple' ? generatedData.simple_quiz : generatedData.complex_quiz;
            const resultBox = document.getElementById(`${type}QuizResult`);
            const submitBtn = document.getElementById(`${type}SubmitQuiz`);
            const quizList = document.getElementById(`${type}QuizList`);

            let correctCount = 0;

            // Check answers and highlight
            quizData.forEach((q, index) => {
                const userAnswer = quizAnswers[type][index];
                const correctAnswer = q.correct_answer;
                const questionDiv = quizList.children[index];
                const options = questionDiv.querySelectorAll('.quiz-option');

                options.forEach(opt => {
                    const optValue = opt.dataset.option;
                    opt.classList.remove('correct', 'incorrect', 'missed');

                    if (optValue === correctAnswer) {
                        opt.classList.add('correct');
                    }
                    if (optValue === userAnswer && userAnswer !== correctAnswer) {
                        opt.classList.add('incorrect');
                    }
                });

                if (userAnswer === correctAnswer) {
                    correctCount++;
                }
            });

            // Calculate grade
            let grade = '';
            let gradeClass = '';
            if (correctCount === 3) {
                grade = 'üèÜ ‰ºòÁßÄ (Excellent!)';
                gradeClass = 'grade-excellent';
            } else if (correctCount === 2) {
                grade = 'üëç ËâØÂ•Ω (Good!)';
                gradeClass = 'grade-good';
            } else {
                grade = 'üìñ ÈúÄË¶ÅÂä†Ê≤π (Keep Learning!)';
                gradeClass = 'grade-fail';
            }

            resultBox.innerHTML = `
        <div class="result-score">Á≠îÂØπ ${correctCount} / 3 È¢ò</div>
        <div class="result-grade ${gradeClass}">${grade}</div>
    `;
            resultBox.style.display = 'block';
            submitBtn.disabled = true;
        }
    </script>
</body>

</html>